%!TEX root = ../main.tex
% vim:nospell

% \newcommand{\cesub}{\ensuremath{{c_\text{e}}}}
\newcommand*\mean[1]{\overline{#1}}
\newcommand{\effj}{\ensuremath{{\text{eff}_j}}}
\newcommand{\effl}{\ensuremath{{\text{eff}_l}}}
\newcommand{\reffl}{\ensuremath{{\text{r,eff}_l}}}
\newcommand{\eg}{\textit{e}.\textit{g}.}
\newcommand{\el}{\ensuremath{{\text{e}_l}}}
\newcommand{\eneg}{\ensuremath{\text{e,neg}}}
\newcommand{\epos}{\ensuremath{\text{e,pos}}}
\newcommand{\etal}{\textit{et~al}.}
\newcommand{\ie}{\textit{i}.\textit{e}.,}
\newcommand{\jinnegposordered}{\ensuremath{j  \in  \left(\text{neg, pos}\right)}}
\newcommand{\jinnegpos}{\ensuremath{j  ∈  \left\{\text{neg, pos}\right\}}}
\newcommand{\jinpossepneg}{\ensuremath{j  ∈  \left\{\text{pos, sep, neg}\right\}}}
\newcommand{\jr}{\ensuremath{{\text{r}_j}}}
\newcommand{\linnegpos}{\ensuremath{l  ∈  \left\{\text{neg, pos}\right\}}}
\newcommand{\linnegseppos}{\ensuremath{l  \in  \{\text{neg, sep, pos}\}}}
\newcommand{\lr}{\ensuremath{{\text{r}_l}}}
\newcommand{\maxj}{\ensuremath{{100\%_j}}}
\newcommand{\maxneg}{\ensuremath{{100\%_\text{neg}}}}
\newcommand{\maxpos}{\ensuremath{{100\%_\text{pos}}}}
\newcommand{\minj}{\ensuremath{{0\%_j}}}
\newcommand{\minneg}{\ensuremath{{0\%_\text{neg}}}}
\newcommand{\minpos}{\ensuremath{{0\%_\text{pos}}}}
\newcommand{\negr}{\ensuremath{{\text{r}_\text{neg}}}}
\newcommand{\nj}{\ensuremath{{\text{n}_j}}}
\newcommand{\nneg}{\ensuremath{{\text{n}_\text{neg}}}}
\newcommand{\npos}{\ensuremath{{\text{n}_\text{pos}}}}
\newcommand{\pj}{\ensuremath{{\text{p}_j}}}
\newcommand{\pl}{\ensuremath{{\text{p}_l}}}
\newcommand{\pneg}{\ensuremath{{\text{p}_\text{neg}}}}
\newcommand{\posr}{\ensuremath{{\text{r}_\text{pos}}}}
\newcommand{\ppos}{\ensuremath{{\text{p}_\text{pos}}}}
\newcommand{\seffl}{\ensuremath{{\text{s,eff}_l}}}
\newcommand{\sjavg}{\ensuremath{{\text{s,avg}_j}}}
\newcommand{\sjmax}{\ensuremath{{\text{s,max}_j}}}
\newcommand{\sjsurf}{\ensuremath{{\text{s,surf}_j}}}
\newcommand{\sj}{\ensuremath{{\text{s}_j}}}
\newcommand{\slmax}{\ensuremath{{\text{s,max}_l}}}
\newcommand{\slsub}{\ensuremath{{\text{s}_l}}}
\newcommand{\slsurf}{\ensuremath{{\text{s,surf}_l}}}
% \newcommand{\eactdsl}{\ensuremath{{_\text{act}^{D_{\text{s}_l}}}}}
\newcommand{\snegmax}{\ensuremath{{\text{s,max}_\text{neg}}}}
\newcommand{\snegmin}{\ensuremath{{\text{s,min}_\text{neg}}}}
\newcommand{\snegsurf}{\ensuremath{{\text{s,surf}_\text{neg}}}}
\newcommand{\sneg}{\ensuremath{\text{s,neg}}}
\newcommand{\sposmax}{\ensuremath{{\text{s,max}_\text{pos}}}}
\newcommand{\spossurf}{\ensuremath{{\text{s,surf}_\text{pos}}}}
\newcommand{\spos}{\ensuremath{\text{s,pos}}}
\newcommand{\tplus}{\ensuremath{{t^0_\text{+}}}}
\newcommand{\viz}{\textit{viz}. }

\DeclarePairedDelimiter\abs{\lvert}{\rvert}

\renewcommand{\footnoterule}{%
    \kern -3pt
    \hrule width 0.25\textwidth height 0.5pt
    \kern 2pt
}

\hyphenation{acad-e-my acad-e-mies af-ter-thought anom-aly anom-alies
    an-ti-deriv-a-tive an-tin-o-my an-tin-o-mies apoth-e-o-ses
    apoth-e-o-sis ap-pen-dix ar-che-typ-al as-sign-a-ble as-sist-ant-ship
    as-ymp-tot-ic asyn-chro-nous at-trib-uted at-trib-ut-able bank-rupt
    bank-rupt-cy bi-dif-fer-en-tial blue-print busier busiest
    cat-a-stroph-ic cat-a-stroph-i-cally con-gress cross-hatched data-base
    de-fin-i-tive de-riv-a-tive dis-trib-ute dri-ver dri-vers eco-nom-ics
    econ-o-mist elit-ist equi-vari-ant ex-quis-ite ex-tra-or-di-nary
    flow-chart for-mi-da-ble forth-right friv-o-lous ge-o-des-ic
    ge-o-det-ic geo-met-ric griev-ance griev-ous griev-ous-ly
    hexa-dec-i-mal ho-lo-no-my ho-mo-thetic ideals idio-syn-crasy
    in-fin-ite-ly in-fin-i-tes-i-mal ir-rev-o-ca-ble key-stroke
    lam-en-ta-ble light-weight mal-a-prop-ism man-u-script mar-gin-al
    meta-bol-ic me-tab-o-lism meta-lan-guage me-trop-o-lis
    met-ro-pol-i-tan mi-nut-est mol-e-cule mono-chrome mono-pole
    mo-nop-oly mono-spline mo-not-o-nous mul-ti-fac-eted mul-ti-plic-able
    non-euclid-ean non-iso-mor-phic non-smooth par-a-digm par-a-bol-ic
    pa-rab-o-loid pa-ram-e-trize para-mount pen-ta-gon phe-nom-e-non
    post-script pre-am-ble pro-ce-dur-al pro-hib-i-tive pro-hib-i-tive-ly
    pseu-do-dif-fer-en-tial pseu-do-fi-nite pseu-do-nym qua-drat-ic
    quad-ra-ture qua-si-smooth qua-si-sta-tion-ary qua-si-tri-an-gu-lar
    quin-tes-sence quin-tes-sen-tial re-arrange-ment rec-tan-gle
    ret-ri-bu-tion retro-fit retro-fit-ted right-eous right-eous-ness
    ro-bot ro-bot-ics sched-ul-ing se-mes-ter semi-def-i-nite
    semi-ho-mo-thet-ic set-up se-vere-ly side-step sov-er-eign spe-cious
    spher-oid spher-oid-al star-tling star-tling-ly sta-tis-tics
    sto-chas-tic straight-est strange-ness strat-a-gem strong-hold
    sum-ma-ble symp-to-matic syn-chro-nous topo-graph-i-cal tra-vers-a-ble
    tra-ver-sal tra-ver-sals treach-ery turn-around un-at-tached
    un-err-ing-ly white-space wide-spread wing-spread wretch-ed
    wretch-ed-ly Eng-lish Euler-ian Feb-ru-ary Gauss-ian
    Hamil-ton-ian Her-mit-ian Jan-u-ary Japan-ese Kor-te-weg
Le-gendre Mar-kov-ian Noe-ther-ian No-vem-ber Rie-mann-ian Sep-tem-ber}

\definecolor{mintedbg}{rgb}{0.95,0.95,0.95}
\definecolor{imperialraspberry}{RGB}{145,0,72}

\definecolor{imperialbrick}{RGB}{165,25,0}
\definecolor{imperialnavy}{RGB}{0,33,71}

\definecolor{imperialblue}{RGB}{0,62,116}
\definecolor{imperiallightblue}{RGB}{0,110,175}
\definecolor{imperialnewblue}{RGB}{0,86,146}

\definecolor{imperialdarkgreen}{RGB}{2,137,59}
\definecolor{imperialprocessblue}{RGB}{0,133,202}

\definecolor{imperiallightgray}{RGB}{235,238,238}
\definecolor{imperialcoolgray}{RGB}{157,157,157}

\definecolor{intermediategray}{RGB}{196,196,196}
\definecolor{lightintergray}{RGB}{215,217,217}

\newcounter{filePrg}
\renewcommand{\CancelColor}{\color{imperialbrick}}

\stackMath
\ExplSyntaxOn
\NewDocumentCommand \vect { s o m }
{
    \IfBooleanTF {#1}
    { \vectaux*{#3} }
    { \IfValueTF {#2} { \vectaux[#2]{#3} } { \vectaux{#3} } }
    ^T
}
\DeclarePairedDelimiterX \vectaux [1] {\lbrack} {\rbrack}
{ \, \dbacc_vect:n { #1 } \, }
\cs_new_protected:Npn \dbacc_vect:n #1
{
    \seq_set_split:Nnn \l_tmpa_seq { , } { #1 }
    \seq_use:Nn \l_tmpa_seq { \enspace }
}
\ExplSyntaxOff

\newtcbinputlisting[use counter=filePrg,number within=chapter,list inside=mypyg]{\matlabcodelisting}[3][]{%
    listing engine=minted,
    minted language=matlab,
    % minted style=algol_nu, % xcode,emacs, perldoc, pastie, borland, vs, vim, tango
    listing file={#2},
    title=\small{\textbf{Listing \thetcbcounter}\quad {#1}},
    % fonttitle=\bfseries,
    listing only,
    list entry={\protect\numberline{\thetcbcounter} #1},
    enhanced jigsaw,
    breakable,
    % drop fuzzy shadow,
    minted options={
        fontsize=\scriptsize,
        breaklines,
        autogobble,
        linenos,
        numbersep=3mm,
        mathescape,
        baselinestretch=1,
        breakanywhere=true
    },
    % colback=offwhite,
    colback=white,
    colframe=imperialnavy,
    % colframe=black,
    % coltitle=white,
    % boxrule=0.2mm,
    left=5mm,
    overlay={\begin{tcbclipinterior}
            \fill[imperiallightgray] (frame.south west) rectangle ([xshift=5mm]frame.north west);
        \end{tcbclipinterior}
    },
    label=#3
}

\pretocmd{\chapter}{\addtocontents{mypyg}{\addvspace{10pt}}}{}{}

\makeatletter % no indent for entries
\renewcommand{\l@tcolorbox}{\@dottedtocline{1}{0pt}{2.3em}}
\makeatother

\makeatletter
\newcommand*{\algrule}[1][\algorithmicindent]{%
    \makebox[#1][l]{%
        \hspace*{.2em}% <------------- This is where the rule starts from
        % \color{imperialcoolgray} \vrule height .75\baselineskip depth .25\baselineskip
        \color{intermediategray} \vrule height .75\baselineskip depth .25\baselineskip
        % \vrule height .75\baselineskip depth .3\baselineskip % https://tex.stackexchange.com/questions/301462/why-are-vertical-rules-dashed-sometimes-with-algorithmic-package
    }
}

\newcount\ALG@printindent@tempcnta
\def\ALG@printindent{%
    \ifnum \theALG@nested>0% is there anything to print
        \ifx\ALG@text\ALG@x@notext% is this an end group without any text?
            % do nothing
    \else
        \unskip
        % draw a rule for each indent level
        \ALG@printindent@tempcnta=1
        \loop
        \algrule[\csname ALG@ind@\the\ALG@printindent@tempcnta\endcsname]%
        \advance \ALG@printindent@tempcnta 1
        \ifnum \ALG@printindent@tempcnta<\numexpr\theALG@nested+1\relax
            \repeat
        \fi
    \fi
}
\patchcmd{\ALG@doentity}{\noindent\hskip\ALG@tlm}{\ALG@printindent}{}{\errmessage{failed to patch}}
\patchcmd{\ALG@doentity}{\item[]\nointerlineskip}{}{}{} % no spurious vertical space
\makeatother

\algnewcommand\algorithmicinput{\textbf{Initialise:}}
\algnewcommand\Initialise{\item[\algorithmicinput]}

\algnewcommand\algorithmicdata{\textbf{User data:}}
\algnewcommand\Userdata{\item[\algorithmicdata]}

\algnewcommand\algorithmicfulllinecomment{\qquad\quad  \scriptsize \textit{Note:}}
\algnewcommand\FullComment{\item[\algorithmicfulllinecomment]}

\makeatletter
\algrenewcommand\ALG@beginalgorithmic{\footnotesize}
\algrenewcommand\algorithmiccomment[2][\footnotesize]{{#1\hfill\(\triangleright\) #2}}
\makeatother

\algblockdefx[NAME]{ISR}{END}%
[2][Unknown]{\textbf{begin} \textproc{Interrupt Service Routine} #1(#2)}%
{\textbf{return} \Comment[\footnotesize]{resume suspended line in \textsc{Main()}}}

\algblockdefx[NAME]{OutputEqn}{EndOutputEqn}%
[2][\textbf{x}]{\textbf{subroutine} \textproc{ComputeCellVoltage}(#2)}%
{\textbf{return} $V_\text{cell}$ \Comment[\footnotesize]{resume suspended line in \textproc{Simulate\gls{spm}}}}

\newsavebox{\algboxA}
\newsavebox{\algboxB}

\let\mathbbalt\mathbb
\DeclareGraphicsExtensions{.pdf, .png, .jpg, .jpeg} %GIF doesn't work??


\newcommand{\setFancyHdr}{
    \pagestyle{fancy}
    \renewcommand{\chaptermark}[1]{\markboth{\MakeUppercase{\thechapter. ##1 }}{}}
    \renewcommand{\sectionmark}[1]{\markright{\thesection\ ##1}}
    \fancyhf{}
    \fancyhead[R]{\bfseries\rightmark}
    \fancyfoot[C]{\thepage}
    \fancypagestyle{plain}{
        \fancyhead{}
        \renewcommand{\headrulewidth}{0pt}
    }
}

\setlength{\headheight}{14.5pt}
\setFancyHdr % Apply fancy header settings otherwise apply it in preamble
\setlength\parskip{0.75\baselineskip plus0.1\baselineskip  minus0.1\baselineskip}


\setlist[enumerate,itemize,description]{topsep=0em}
\setcounter{secnumdepth}{3} % organisational level that receives a numbers
\setcounter{tocdepth}{3}    % print table of contents for level 3


\renewcommand{\chaptername}{} % uncomment to print only "1" not "Chapter 1"
\titleformat{\chapter}[display]
{\bfseries\sffamily\Huge}
{\hfill\fontsize{140}{50}\selectfont\color{lightgray}\rmfamily\textbf{\thechapter}}% label
{-0ex}
{\filleft\fontsize{50}{50}}
[\vspace{-0ex}]

\setlength{\columnsep}{20pt} % space between columns; default 10pt quite narrow

\newcolumntype{P}[1]{>{\RaggedRight\hspace{0pt}}p{#1}}
% \newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}


\sisetup{
    locale = UK ,
    per-mode = reciprocal-positive-first,
    binary-units = true
}
\sisetup{range-phrase=--}
\sisetup{range-units=single}

\fxsetup{theme=color, marginface=\singlespacing \scriptsize}

\definecolor{fxnote}{RGB}{165,25,0} % imperialbrick

\diffset[p-delims = . |, p-nudge = 0]

\renewcommand{\thefootnote}{\fnsymbol{footnote}}


\makeatletter
\@addtoreset{algorithm}{chapter}% algorithm counter resets every chapter
\makeatother
\renewcommand{\thealgorithm}{\thechapter.\arabic{algorithm}}% Algorithm # is <chapter>.<algorithm>

\providecommand\algorithmname{algorithm}
\captionsetup[ruled]{font=small,labelfont={bf},labelsep=quad}

\newcommand{\tempcaption}{}% stores the caption
\newcommand{\templabel}{}% stores the label

\newenvironment{customalgo}[3][0.7\textwidth]
{%
    \begin{minipage}{#1}
        \begin{algorithm}[H]
            \centering
            \gdef\tempcaption{#2}% store the caption so we can use it later
            \gdef\templabel{#3}% store the label so we can use it later
            \begin{algorithmic}[1]
            }%
            {%
            \end{algorithmic}
            \caption{\tempcaption}% use the stored caption
            \label{\templabel}
        \end{algorithm}
    \end{minipage}
    % \smallskip
}%

\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\newenvironment{mycenter}[1][\topsep]
{\setlength{\topsep}{#1}\par\kern\topsep\centering}% \begin{mycenter}[<len>]
{\par\kern\topsep}% \end{mycenter}

\makeatletter
\renewcommand*\env@matrix[1][\arraystretch]{%
    \edef\arraystretch{#1}%
    \hskip -\arraycolsep
    \let\@ifnextchar\new@ifnextchar
\array{*\c@MaxMatrixCols c}}
\makeatother

\let\Algorithm\algorithm
\renewcommand\algorithm[1][]{\Algorithm[#1]\setstretch{1.2390625}}

\makeatletter
\newcommand{\algcolor}[2]{%
    \hskip-\ALG@thistlm\colorbox{#1}{\parbox{\dimexpr\linewidth-2\fboxsep}{\hskip\ALG@thistlm\relax #2}}%
}
\newcommand{\algemph}[1]{\algcolor{imperiallightgray}{#1}}
\makeatother

\SetupFloatingEnvironment{listing}{name=Code snippet}


\crefname{listing}{\MakeLowercase{\listingname}}{\MakeLowercase{\listingname s}}
\crefname{appchap}{appendix}{appendices}

\def\Vhrulefill{\leavevmode\leaders\hrule height 0.7ex depth \dimexpr0.4pt-0.7ex\hfill\kern0pt}

\makeatletter
\newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

\renewcommand{\gitMarkFormat}{\color{imperialraspberry} \small}
\renewcommand{\gitMark}{Git branch: '\gitBranch'\, \textbullet{}\, Commit SHA: \fbox{\texttt{\textbf{\gitAbbrevHash{}}}} \textbullet{}\, Last commit: \gitReln{} (\gitAuthorIsoDate) \\ }
\renewcommand{\gitMarkPref}{[Draft]}

\makeatletter

\newcommand*{\@rowstyle}{}

\newcommand*{\rowstyle}[1]{% sets the style of the next row
    \gdef\@rowstyle{#1}%
    \@rowstyle\ignorespaces%
}

\newcolumntype{=}{% resets the row style
    >{\gdef\@rowstyle{}}%
}

\newcolumntype{+}{% adds the current row style to the next column
    >{\@rowstyle}%
}

\makeatother

\newcounter{descriptcount}
\newlist{enumdescriptnum}{description}{1}
\setlist[enumdescriptnum] {%
    before={\setcounter{descriptcount}{0}%
    \renewcommand*\thedescriptcount{\alph{descriptcount}.}}
    ,font=\footnotesize{\bfseries\stepcounter{descriptcount}\thedescriptcount~}
}

\newcommand{\customenum}[2]{
\item[$ \symbf{#1}\  (\times #2)$]
}

\crefname{filePrg}{listing}{listings}
\Crefname{filePrg}{Listing}{Listings}
\newcommand{\crefrangeconjunction}{--}
\crefrangeformat{equation}{(#3#1#4)--(#5#2#6)}

\makeatletter
\global\let\tikz@ensure@dollar@catcode=\relax
\makeatother

\setabbreviationstyle[acronym]{long-short}% glossaries-extra.sty only

\makeatletter
\newcounter{savepagenumber}
\renewcommand\mainmatter{%
    \cleardoublepage
    \setcounter{savepagenumber}{\value{page}}
    \@mainmattertrue
    \pagenumbering{arabic}%
}
\renewcommand\backmatter{%
    \if@openright
        \cleardoublepage
    \else
        \clearpage
    \fi
    \pagenumbering{roman}%
    \setcounter{page}{\value{savepagenumber}}%
    \@mainmatterfalse
}
\makeatother

% \renewcommand*{\glstextformat}[1]{\textsf{#1}}
\renewcommand*{\glstextformat}[1]{\textcolor{black}{#1}} % link coloring to match normal text, ie black
\preto\chapter{\glsresetall} % expand acronyms every chapter https://tex.stackexchange.com/questions/435617/glossaries-expand-acronyms-for-first-time-use-within-each-chapter/435680#435680

\WarningFilter{latex}{Marginpar on page}

\DeclareSIUnit \amphour { Ah }
\setkeys{Gin}{width=0.75\textwidth} % default width of graphics

\renewcommand*{\bibfont}{\small} % make Bibliography left aligned, not justified

\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=doi,final]
            \step[fieldset=url,null]
        }
    }
}

\DefineBibliographyStrings{english}{%
    backrefpage = {cited on page},% originally "cited on page"
    backrefpages = {cited on pages},% originally "cited on pages"
}

\xpatchbibmacro{pageref}{parens}{brackets}{}{}   % helpful to replace parens with brackets for backreferencing with biblatex % needs xpatch

% \renewbibmacro*{pageref}{\iflistundef{pageref}{}{\printtext[brackets]{\printlist[​pageref][-\value{listtotal}]{pageref}}}}

% \titleformat*{\section}{\large\bfseries}
\titleformat{\section}{\normalfont\fontsize{16}{21}\bfseries}{\thesection}{1em}{}

\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map[overwrite]{
            \step[fieldsource=month, match=\regexp{\Ajan\Z}, replace=1]
            \step[fieldsource=month, match=\regexp{\Afeb\Z}, replace=2]
            \step[fieldsource=month, match=\regexp{\Amar\Z}, replace=3]
            \step[fieldsource=month, match=\regexp{\Aapr\Z}, replace=4]
            \step[fieldsource=month, match=\regexp{\Amay\Z}, replace=5]
            \step[fieldsource=month, match=\regexp{\Ajun\Z}, replace=6]
            \step[fieldsource=month, match=\regexp{\Ajul\Z}, replace=7]
            \step[fieldsource=month, match=\regexp{\Aaug\Z}, replace=8]
            \step[fieldsource=month, match=\regexp{\Asep\Z}, replace=9]
            \step[fieldsource=month, match=\regexp{\Aoct\Z}, replace=10]
            \step[fieldsource=month, match=\regexp{\Anov\Z}, replace=11]
            \step[fieldsource=month, match=\regexp{\Adec\Z}, replace=12]
        }
    }
}

% \makesavenoteenv{tabular}
% \makesavenoteenv{table}

\newcommand*{\xdash}[1][3em]{\rule[0.5ex]{#1}{0.55pt}}

% \newcommand{\corresponds}{\overset{\scriptscriptstyle\wedge}{=}}

% aligning substack quantities (defines a new command subalign)
% https://tex.stackexchange.com/questions/198771/align-in-substack
% \makeatletter
% \newcommand{\subalign}[1]{%
%     \vcenter{%
%         \Let@ \restore@math@cr \default@tag
%         \baselineskip\fontdimen10 \scriptfont\tw@
%         \advance\baselineskip\fontdimen12 \scriptfont\tw@
%         \lineskip\thr@@\fontdimen8 \scriptfont\thr@@
%         \lineskiplimit\lineskip
%         \ialign{\hfil$\m@th\scriptstyle##$&$\m@th\scriptstyle{}##$\crcr
%             #1\crcr
%         }%
%     }
% }
% \makeatother

% \newcolumntype{L}{>{\scriptstyle}l}
% \newcolumntype{C}{>{\scriptstyle}c}
% \newcolumntype{R}{>{\scriptstyle}r}
% \newenvironment{mysubarray}{%
%     \scriptstyle
%     \setlength\arraycolsep{0pt}%
%     \setlength\extrarowheight{-1ex}
%     \renewcommand\arraystretch{0}
% \begin{array}{RCL}}{\end{array}}

% \makeatletter
% \newcommand{\pushright}[1]{\ifmeasuring@#1\else\omit\hfill$\displaystyle#1$\fi\ignorespaces}
% \makeatother

\renewcommand{\ULdepth}{4.0pt}
\renewcommand{\ULthickness}{0.75pt}

