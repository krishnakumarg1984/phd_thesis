% -*- root: ../main.tex -*-
%!TEX root = ../main.tex
% vim:nospell

\usepackage{mathtools}
\usepackage{lualatex-math}
\usepackage{subcaption}
% \captionsetup{compatibility=false}
\usepackage[nameinlink]{cleveref}
\crefname{filePrg}{listing}{listings}
\Crefname{filePrg}{Listing}{Listings}
\newcommand{\crefrangeconjunction}{--}
\crefrangeformat{equation}{(#3#1#4)--(#5#2#6)}
\DeclareSIUnit{\amphours}{Ah}

% Patches for algorithmicx with vertical lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% https://tex.stackexchange.com/questions/292815/how-can-i-create-vertical-lines-indentation-in-algorithm-pseudo-code-correctly-w?noredirect=1&lq=1
% \usepackage{etoolbox} % already loaded in class file

\makeatletter
% start with some helper code
% This is the vertical rule that is inserted
\newcommand*{\algrule}[1][\algorithmicindent]{%
    \makebox[#1][l]{%
        \hspace*{.2em}% <------------- This is where the rule starts from
        % \color{imperialcoolgray} \vrule height .75\baselineskip depth .25\baselineskip
        \color{intermediategray} \vrule height .75\baselineskip depth .25\baselineskip
        % \vrule height .75\baselineskip depth .3\baselineskip % https://tex.stackexchange.com/questions/301462/why-are-vertical-rules-dashed-sometimes-with-algorithmic-package
    }
}

\newcount\ALG@printindent@tempcnta
\def\ALG@printindent{%
    \ifnum \theALG@nested>0% is there anything to print
        \ifx\ALG@text\ALG@x@notext% is this an end group without any text?
            % do nothing
    \else
        \unskip
        % draw a rule for each indent level
        \ALG@printindent@tempcnta=1
        \loop
        \algrule[\csname ALG@ind@\the\ALG@printindent@tempcnta\endcsname]%
        \advance \ALG@printindent@tempcnta 1
        \ifnum \ALG@printindent@tempcnta<\numexpr\theALG@nested+1\relax
            \repeat
        \fi
    \fi
}
% the following line injects our new indent handling code in place of the default spacing
\patchcmd{\ALG@doentity}{\noindent\hskip\ALG@tlm}{\ALG@printindent}{}{\errmessage{failed to patch}}
\patchcmd{\ALG@doentity}{\item[]\nointerlineskip}{}{}{} % no spurious vertical space
% end vertical rule patch for algorithmicx
\makeatother

% https://tex.stackexchange.com/questions/292815/how-can-i-create-vertical-lines-indentation-in-algorithm-pseudo-code-correctly-w?noredirect=1&lq=1
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand*\Let[2]{\State #1 $\gets$ #2}

\algnewcommand\algorithmicinput{\textbf{Initialise:}}
\algnewcommand\Initialise{\item[\algorithmicinput]}

\algnewcommand\algorithmicdata{\textbf{User data:}}
\algnewcommand\Userdata{\item[\algorithmicdata]}

\algnewcommand\algorithmicfulllinecomment{\qquad\quad  \scriptsize \textit{Note:}}
\algnewcommand\FullComment{\item[\algorithmicfulllinecomment]}

\makeatletter
\algrenewcommand\ALG@beginalgorithmic{\footnotesize}
\algrenewcommand\algorithmiccomment[2][\footnotesize]{{#1\hfill\(\triangleright\) #2}}
\makeatother

\algblockdefx[NAME]{ISR}{END}%
[2][Unknown]{\textbf{begin} \textproc{Interrupt Service Routine} #1(#2)}%
{\textbf{return} \Comment[\footnotesize]{resume suspended line in \textsc{Main()}}}


\algblockdefx[NAME]{OutputEqn}{EndOutputEqn}%
[2][\textbf{x}]{\textbf{subroutine} \textproc{ComputeCellVoltage}(#2)}%
{\textbf{return} $V_\text{cell}$ \Comment[\footnotesize]{resume suspended line in \textproc{Simulate\gls{spm}}}}

\newsavebox{\algboxA}
\newsavebox{\algboxB}

\usepackage{varwidth}

% \renewcommand{\thefootnote}{\fnsymbol{footnote}}
\renewcommand{\thefootnote}{\fnsymbol{footnote}}

% \setmathfont[range={mathscr,mathbfscr},StylisticSet=1,Scale=MatchUppercase]{XITS Math}
\setmathfont[range={\mathunder,\triangleq},Scale=MatchUppercase]{STIX2Math.otf}
% \setmathfont[range={\mathunder},Scale=MatchUppercase]{Latin Modern Math}

\allowdisplaybreaks

\makeatletter
\@addtoreset{algorithm}{chapter}% algorithm counter resets every chapter
\makeatother
\renewcommand{\thealgorithm}{\thechapter.\arabic{algorithm}}% Algorithm # is <chapter>.<algorithm>

\providecommand\algorithmname{algorithm}
\captionsetup[ruled]{font=small,labelfont={bf},labelsep=quad}

\newcommand{\tempcaption}{}% stores the caption
\newcommand{\templabel}{}% stores the label

\newenvironment{customalgo}[3][0.7\textwidth]
{%
    \begin{minipage}{#1}
        \begin{algorithm}[H]
            \centering
            \gdef\tempcaption{#2}% store the caption so we can use it later
            \gdef\templabel{#3}% store the label so we can use it later
            \begin{algorithmic}[1]
            }%
            {%
            \end{algorithmic}
            \caption{\tempcaption}% use the stored caption
            \label{\templabel}
        \end{algorithm}
    \end{minipage}
    % \smallskip
}%

\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\newenvironment{mycenter}[1][\topsep]
{\setlength{\topsep}{#1}\par\kern\topsep\centering}% \begin{mycenter}[<len>]
{\par\kern\topsep}% \end{mycenter}

\usepackage{bigints}

\makeatletter
\renewcommand*\env@matrix[1][\arraystretch]{%
  \edef\arraystretch{#1}%
  \hskip -\arraycolsep
  \let\@ifnextchar\new@ifnextchar
  \array{*\c@MaxMatrixCols c}}
\makeatother


\let\Algorithm\algorithm
\renewcommand\algorithm[1][]{\Algorithm[#1]\setstretch{1.2390625}}

% \usepackage{scalerel,stackengine}
% \newcommand\equalhat{\mathrel{\stackon[1.5pt]{=}{\stretchto{%
%                     \scalerel*[\widthof{=}]{\wedge}{\rule{1ex}{3ex}}}{0.5ex}}}}

\makeatletter
\newcommand{\algcolor}[2]{%
  \hskip-\ALG@thistlm\colorbox{#1}{\parbox{\dimexpr\linewidth-2\fboxsep}{\hskip\ALG@thistlm\relax #2}}%
}
\newcommand{\algemph}[1]{\algcolor{imperiallightgray}{#1}}
\makeatother

\SetupFloatingEnvironment{listing}{name=Code snippet}
% \crefname{listing}{code snippet}{code snippets}
\crefname{listing}{\MakeLowercase{\listingname}}{\MakeLowercase{\listingname s}}

\crefname{appchap}{appendix}{appendices}

% \usemintedstyle[matlab]{manni}
\usepackage{threeparttable}

% \usepackage{xhfill}
% \def\Vhrulefill{\leavevmode\leaders\hrule height 0.7ex depth \dimexpr0.4pt-0.7ex\hfill\kern0pt}

\makeatletter
\newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother


% % needs etoolbox defines a Rowcolor
% \makeatletter
% \newlength{\qrr@dimen@}
% \expandafter\pretocmd\csname tabular*\endcsname{\setlength{\qrr@dimen@}{#1}}{}{}
% \newcommand*{\Rowcolor}[2][\tabcolsep]{%
%     \ifx\relax#1\relax\else
%         \kern-\the\dimexpr#1\relax
%     \fi
%     \makebox[0pt][l]{%
%         \fboxsep=0pt
%         \colorbox{#2}{%
%             \strut\kern\qrr@dimen@
%         }%
%     }%
%     \ifx\relax#1\relax\else
%         \kern\the\dimexpr#1\relax
%     \fi
%     \ignorespaces
% }
% \makeatother


\usepackage{tabularx}       % new
% \usepackage{boldline}       % new (part of shipunov bundle)
% \usepackage{cellspace}      % new
% \setlength\cellspacetoplimit{4pt}
% \setlength\cellspacebottomlimit{4pt}
% \addparagraphcolumntypes{X}
\newcolumntype{C}{>{\centering\arraybackslash}X}
\newcolumntype{L}{>{\raggedright\arraybackslash}X}
% \newcolumntype{L}[1]{>{\hsize=#1\hsize\RaggedRight} X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}
